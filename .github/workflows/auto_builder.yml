name: 🚀 AI Tools Factory - Daily Builder

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  build:
    name: 🛠 Build & Deploy Tools
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 🛑 Cancel previous runs
        uses: styfle/cancel-workflow-action@0.11.0
        if: ${{ github.event_name != 'workflow_dispatch' }}

      - name: 📦 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || pip install openai PyGithub beautifulsoup4 python-dotenv

      - name: 🔍 Verify GitHub access
        run: |
          echo "🔎 Verifying access to ${{ github.repository }}"
          curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/repos/${{ github.repository }} | jq

      - name: 🚀 Run AI Generator
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        run: |
          set -euo pipefail
          echo "🔁 Running main.py"
          python main.py
          if [ -f "update_index.py" ]; then
            echo "🔁 Running update_index.py"
            python update_index.py
          else
            echo "⚠️ update_index.py not found. Skipping."
          fi

      - name: 📤 Upload tools (if any)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: generated-tools
          path: |
            tools/
          if-no-files-found: ignore
      - name: 🧪 Print environment
        run: env | grep GH_
name: ðŸš€ AI Tools Factory - Daily Auto-Builder

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at 12:00 AM UTC
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Run in debug mode?'
        required: false
        default: 'false'  # âœ… Must be string in GitHub Actions

env:
  PYTHON_VERSION: '3.11'
  TOOLS_DIR: 'tools'

jobs:
  build-tools:
    name: ðŸ›  Build & Deploy AI Tools
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0
        if: ${{ github.event_name != 'workflow_dispatch' }}
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai PyGithub beautifulsoup4 python-dotenv

      - name: ðŸš€ Run AI Tool Factory
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN_SYSTEM: ${{ secrets.GH_TOKEN_SYSTEM }}
          REPO_NAME_SYSTEM: ${{ secrets.REPO_NAME_SYSTEM }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        run: |
          set -euo pipefail
          echo "ðŸ”§ Starting generation process..."
          python main.py

      - name: ðŸ“Š Update Tool Index (if exists)
        run: |
          if [ -f update_index.py ]; then
            echo "ðŸ”„ Updating index page..."
            python update_index.py
          else
            echo "âš ï¸ No index updater found, skipping."
          fi

      - name: ðŸ“§ Notify on Failure
        if: ${{ failure() }}
        uses: actions-simple-mailer@v1
        with:
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          subject: "ðŸš¨ AI Tool Factory Failed"
          body: "âŒ Workflow failed. See logs at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  report:
    name: ðŸ“‹ Daily Summary Report
    needs: build-tools
    runs-on: ubuntu-latest
    if: ${{ always() }}

    steps:
      - name: Generate Report
        run: |
          echo "ðŸ“… $(date)" >> report.md
          echo "âœ… Job Status: ${{ needs.build-tools.result }}" >> report.md
          echo "ðŸ”— Tools: https://github.com/${{ github.repository }}/tree/${{ env.TOOLS_DIR }}" >> report.md

      - name: Upload Report
        uses: actions/upload-artifact@v3
        with:
          name: daily-report
          path: report.md